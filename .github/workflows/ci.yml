name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_all_tests:
        description: 'Run all service tests (for showcase)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      user-service: ${{ steps.changes.outputs.user-service }}
      campaign-service: ${{ steps.changes.outputs.campaign-service }}
      pledge-service: ${{ steps.changes.outputs.pledge-service }}
      payment-service: ${{ steps.changes.outputs.payment-service }}
      totals-service: ${{ steps.changes.outputs.totals-service }}
      notification-service: ${{ steps.changes.outputs.notification-service }}
      shared: ${{ steps.changes.outputs.shared }}
      gateway: ${{ steps.changes.outputs.gateway }}
      frontend: ${{ steps.changes.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            shared:
              - 'services/shared/**'
            user-service:
              - 'services/user-service/**'
            campaign-service:
              - 'services/campaign-service/**'
            pledge-service:
              - 'services/pledge-service/**'
            payment-service:
              - 'services/payment-service/**'
            totals-service:
              - 'services/totals-service/**'
            notification-service:
              - 'services/notification-service/**'
            gateway:
              - 'gateway/**'
            frontend:
              - 'frontend/**'
      - name: Debug outputs
        run: |
          echo "shared: ${{ steps.changes.outputs.shared }}"
          echo "user-service: ${{ steps.changes.outputs.user-service }}"
          echo "campaign-service: ${{ steps.changes.outputs.campaign-service }}"
          echo "pledge-service: ${{ steps.changes.outputs.pledge-service }}"
          echo "payment-service: ${{ steps.changes.outputs.payment-service }}"
          echo "totals-service: ${{ steps.changes.outputs.totals-service }}"
          echo "notification-service: ${{ steps.changes.outputs.notification-service }}"

  test-shared:
    needs: detect-changes
    if: needs.detect-changes.outputs.shared == 'true' || github.event.inputs.run_all_tests == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/shared
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/shared/package.json
      - run: npm install
      - run: npm run build
      - run: npm test

  test-user-service:
    needs: [detect-changes, test-shared]
    if: always() && (needs.detect-changes.outputs.user-service == 'true' || needs.detect-changes.outputs.shared == 'true' || github.event.inputs.run_all_tests == 'true')
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/user-service
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/user-service/package.json
      - run: npm install
      - run: npm run build
      - run: npm test

  test-campaign-service:
    needs: [detect-changes, test-shared]
    if: always() && (needs.detect-changes.outputs.campaign-service == 'true' || needs.detect-changes.outputs.shared == 'true' || github.event.inputs.run_all_tests == 'true')
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/campaign-service
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/campaign-service/package.json
      - run: npm install
      - run: npm run build
      - run: npm test

  test-pledge-service:
    needs: [detect-changes, test-shared]
    if: always() && (needs.detect-changes.outputs.pledge-service == 'true' || needs.detect-changes.outputs.shared == 'true' || github.event.inputs.run_all_tests == 'true')
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/pledge-service
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/pledge-service/package.json
      - run: npm install
      - run: npm run build
      - run: npm test

  test-payment-service:
    needs: [detect-changes, test-shared]
    if: always() && (needs.detect-changes.outputs.payment-service == 'true' || needs.detect-changes.outputs.shared == 'true' || github.event.inputs.run_all_tests == 'true')
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/payment-service
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/payment-service/package.json
      - run: npm install
      - run: npm run build
      - run: npm test

  test-totals-service:
    needs: [detect-changes, test-shared]
    if: always() && (needs.detect-changes.outputs.totals-service == 'true' || needs.detect-changes.outputs.shared == 'true' || github.event.inputs.run_all_tests == 'true')
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/totals-service
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/totals-service/package.json
      - run: npm install
      - run: npm run build
      - run: npm test

  test-notification-service:
    needs: [detect-changes, test-shared]
    if: always() && (needs.detect-changes.outputs.notification-service == 'true' || needs.detect-changes.outputs.shared == 'true' || github.event.inputs.run_all_tests == 'true')
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/notification-service
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/notification-service/package.json
      - run: npm install
      - run: npm run build
      - run: npm test

  build-images:
    needs: [detect-changes, test-shared, test-user-service, test-campaign-service, test-pledge-service, test-payment-service, test-totals-service, test-notification-service]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build User Service
        if: ${{ needs.detect-changes.outputs.user-service == 'true' || github.event.inputs.run_all_tests == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./services/user-service
          push: false
          tags: careforall/user-service:${{ github.sha }}

      - name: Build Campaign Service
        if: ${{ needs.detect-changes.outputs.campaign-service == 'true' || github.event.inputs.run_all_tests == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./services/campaign-service
          push: false
          tags: careforall/campaign-service:${{ github.sha }}

      - name: Build Pledge Service
        if: ${{ needs.detect-changes.outputs.pledge-service == 'true' || github.event.inputs.run_all_tests == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./services/pledge-service
          push: false
          tags: careforall/pledge-service:${{ github.sha }}

      - name: Build Payment Service
        if: ${{ needs.detect-changes.outputs.payment-service == 'true' || github.event.inputs.run_all_tests == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./services/payment-service
          push: false
          tags: careforall/payment-service:${{ github.sha }}

      - name: Build Totals Service
        if: ${{ needs.detect-changes.outputs.totals-service == 'true' || github.event.inputs.run_all_tests == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./services/totals-service
          push: false
          tags: careforall/totals-service:${{ github.sha }}

      - name: Build Notification Service
        if: ${{ needs.detect-changes.outputs.notification-service == 'true' || github.event.inputs.run_all_tests == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./services/notification-service
          push: false
          tags: careforall/notification-service:${{ github.sha }}

      - name: Build Gateway
        if: ${{ needs.detect-changes.outputs.gateway == 'true' || github.event.inputs.run_all_tests == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./gateway
          push: false
          tags: careforall/gateway:${{ github.sha }}

  deploy:
    needs: build-images
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy with Docker Compose
        run: |
          echo "Deployment would run docker-compose up -d here"
          echo "For demo purposes, we'll just validate the compose file"
          docker compose config

  ci-success:
    needs: [test-shared, test-user-service, test-campaign-service, test-pledge-service, test-payment-service, test-totals-service, test-notification-service]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check CI Status
        run: |
          echo "CI Pipeline completed"
          echo "All tests have been executed for changed services"
          echo "Shared: ${{ needs.test-shared.result }}"
          echo "User Service: ${{ needs.test-user-service.result }}"
          echo "Campaign Service: ${{ needs.test-campaign-service.result }}"
          echo "Pledge Service: ${{ needs.test-pledge-service.result }}"
          echo "Payment Service: ${{ needs.test-payment-service.result }}"
          echo "Totals Service: ${{ needs.test-totals-service.result }}"
          echo "Notification Service: ${{ needs.test-notification-service.result }}"
